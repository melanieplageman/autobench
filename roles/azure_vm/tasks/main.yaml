# names chosen according to recommendations in
# https://docs.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging
# with consideration of naming scope

- name: Get my IP address"
  tags: test_ip
  community.general.ipify_facts:
  register: ipify_public_ip

- name: Generate OpenSSH public key
  openssh_keypair:
    path: "{{ privatekey | default(playbook_dir + '/id') }}"
    type: ed25519
    regenerate: never
  register: keypair

- name: Create a Resource Group
  azure_rm_resourcegroup:
    name: "{{ resource_group_name }}"
    location: "{{ location }}"
  register: resource_group

- name: Create a Network Security Group
  azure_rm_securitygroup:
    resource_group: "{{ resource_group.state.name }}"
    name: nsg-sshallow-001
    purge_default_rules: yes
    purge_rules: yes
    rules:
    - name: AllowSSH
      protocol: Tcp
      destination_port_range: 22
      access: Allow
      priority: 100
      direction: Inbound
      source_address_prefix:
      - "{{ ipify_public_ip.ansible_facts.ipify_public_ip }}"
  register: security_group

- name: Create a Virtual Network
  azure_rm_virtualnetwork:
    name: "vnet-incubator-{{ location }}-001"
    resource_group: "{{ resource_group.state.name }}"
    address_prefixes_cidr:
    - "10.0.0.0/16"
  register: virtual_network

- name: Create a Subnet in the Virtual Network
  azure_rm_subnet:
    name: "snet-incubator-{{ location }}-001"
    resource_group: "{{ resource_group.state.name }}"
    virtual_network: "{{ virtual_network.state.name }}"
    address_prefix_cidr: "10.0.0.0/24"
    security_group: "{{ security_group.state.name }}"
  register: subnet

- name: Create a Public IP Address
  azure_rm_publicipaddress:
    name: "pip-vmiobench-{{ location }}-001"
    resource_group: "{{ resource_group.state.name }}"
    allocation_method: static
  register: public_ip_address

- name: Create a Network Interface
  azure_rm_networkinterface:
    name: "nic-01-vmiobench-incubator-001"
    resource_group: "{{ resource_group.state.name }}"
    virtual_network: "{{ virtual_network.state.name }}"
    security_group: "{{ security_group.state.name }}"
    subnet_name: "{{ subnet.state.name }}"
    ip_configurations:
    - name: "vmiobench-ipconfig-001"
      public_ip_address_name: "{{ public_ip_address.state.name }}"
      primary: True
  register: network_interface

# TODO: create a storage account and use it below

# not able to attach storage to VM currently due to bug
# https://github.com/ansible-collections/azure/issues/146
# after bug is resolved, will be able to put managed_disk_id in VM
# until then, I can only make disks that are less than 1 TB
# - name: Create a data disk
#   azure_rm_manageddisk:
#     name: dd-test-data-disk2
#     resource_group: "{{ resource_group.state.name }}"
#     create_option: empty
#     storage_account_type: Premium_LRS
#     os_type: linux 
#     attach_caching: read_only 
#     disk_size_gb: 10
#   register: data_disk

- name: Create a VM
  azure_rm_virtualmachine:
    admin_username: "{{ ansible_user_id }}"
    ssh_password_enabled: false
    name: vmiobench-001
    resource_group: "{{ resource_group.state.name }}"
    vm_size: "{{ instance_size }}"
    virtual_network: "{{ virtual_network.state.name }}"
    subnet: "{{ subnet.state.name }}"
    network_interfaces: "{{ network_interface.state.name }}"
    image:
      offer: debian-10
      publisher: Debian
      sku: 10
      version: latest
    ssh_public_keys:
    - path: "/home/{{ ansible_user_id }}/.ssh/authorized_keys"
      key_data: "{{ keypair.public_key }}"
    managed_disk_type: Premium_LRS
    data_disks:
    - lun: 0
      disk_size_gb: 50
      caching: None
      managed_disk_type: Premium_LRS

- name: VM's public IP address
  debug: var=public_ip_address.state.ip_address

- name: Update Ansible's inventory file
  template:
    dest: "{{ playbook_dir }}/hosts"
    src: hosts.j2

- name: Reload Ansible's inventory file
  meta: refresh_inventory
